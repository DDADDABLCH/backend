<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>블록체인 기부 플랫폼 테스트</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.8.2/web3.min.js"></script>
    <style>
      body {
        font-family: "Pretendard", Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f7fa;
        color: #333;
      }
      .container {
        background-color: #fff;
        border-radius: 10px;
        padding: 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #3182ce;
        text-align: center;
      }
      .card {
        background-color: #fff;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        border-left: 4px solid #3182ce;
      }
      .section {
        margin-bottom: 30px;
      }
      .btn {
        background-color: #3182ce;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.3s;
      }
      .btn:hover {
        background-color: #2c5282;
      }
      .btn-secondary {
        background-color: #718096;
      }
      .btn-secondary:hover {
        background-color: #4a5568;
      }
      input,
      select {
        width: 100%;
        padding: 10px;
        margin-bottom: 15px;
        border: 1px solid #e2e8f0;
        border-radius: 5px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #4a5568;
      }
      .status {
        margin-top: 20px;
        padding: 15px;
        background-color: #f0fff4;
        border-left: 4px solid #48bb78;
        border-radius: 5px;
      }
      .error {
        background-color: #fff5f5;
        border-left: 4px solid #f56565;
      }
      .tabs {
        display: flex;
        margin-bottom: 20px;
      }
      .tab {
        padding: 10px 20px;
        cursor: pointer;
        background-color: #e2e8f0;
        border-radius: 5px 5px 0 0;
        margin-right: 5px;
      }
      .tab.active {
        background-color: #3182ce;
        color: white;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .account-info {
        background-color: #ebf8ff;
        padding: 10px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e2e8f0;
      }
      th {
        background-color: #f7fafc;
        font-weight: bold;
      }
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 0, 0, 0.1);
        border-radius: 50%;
        border-top-color: #3182ce;
        animation: spin 1s ease-in-out infinite;
        margin-left: 10px;
        vertical-align: middle;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>블록체인 기부 플랫폼 테스트</h1>

      <div class="card account-info">
        <h3>계정 정보</h3>
        <p>연결된 계정: <span id="accountAddress">연결되지 않음</span></p>
        <p>잔액: <span id="accountBalance">0</span> ETH</p>
        <button id="connectWallet" class="btn">지갑 연결하기</button>
      </div>

      <div class="tabs">
        <div class="tab active" data-tab="donate">기부하기</div>
        <div class="tab" data-tab="register">수혜자 등록</div>
        <div class="tab" data-tab="info">컨트랙트 정보</div>
      </div>

      <div class="tab-content active" id="donate">
        <div class="card">
          <h3>기부하기</h3>
          <div class="section">
            <label for="donationAmount">기부 금액 (ETH)</label>
            <input
              type="number"
              id="donationAmount"
              min="0.01"
              step="0.01"
              value="0.1"
            />

            <label for="donationMessage">메시지 (선택사항)</label>
            <input
              type="text"
              id="donationMessage"
              placeholder="응원 메시지를 남겨주세요"
            />

            <button id="donateButton" class="btn">기부하기</button>
          </div>
          <div id="donationStatus" class="status" style="display: none"></div>
        </div>
      </div>

      <div class="tab-content" id="register">
        <div class="card">
          <h3>수혜자 등록</h3>
          <div class="section">
            <label for="beneficiaryAddress">수혜자 주소</label>
            <input type="text" id="beneficiaryAddress" placeholder="0x..." />

            <label for="beneficiaryName">수혜자 이름</label>
            <input
              type="text"
              id="beneficiaryName"
              placeholder="이름 또는 단체명"
            />

            <label for="beneficiaryDescription">설명</label>
            <input
              type="text"
              id="beneficiaryDescription"
              placeholder="간단한 설명을 입력하세요"
            />

            <button id="registerButton" class="btn">수혜자 등록하기</button>
          </div>
          <div
            id="registrationStatus"
            class="status"
            style="display: none"
          ></div>
        </div>
      </div>

      <div class="tab-content" id="info">
        <div class="card">
          <h3>컨트랙트 정보</h3>
          <div class="section">
            <p>
              컨트랙트 주소:
              <input
                type="text"
                id="contractAddress"
                placeholder="컨트랙트 주소를 입력하세요"
              />
            </p>
            <button id="loadContractButton" class="btn">
              컨트랙트 불러오기
            </button>
          </div>

          <div class="section">
            <h4>총 기부 금액</h4>
            <p id="totalDonations">0 ETH</p>

            <h4>등록된 수혜자</h4>
            <div id="beneficiariesList">
              <table id="beneficiariesTable">
                <thead>
                  <tr>
                    <th>주소</th>
                    <th>이름</th>
                    <th>설명</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- 여기에 수혜자 목록이 표시됩니다 -->
                </tbody>
              </table>
            </div>
          </div>

          <div id="contractStatus" class="status" style="display: none"></div>
        </div>
      </div>
    </div>

    <script>
      // 전역 변수
      let web3;
      let accounts = [];
      let donationContract;
      let contractABI = [
        // 여기에 컨트랙트 ABI를 입력하세요
        // 예시 ABI (실제 사용 시 변경해야 합니다)
        {
          inputs: [
            { internalType: "string", name: "_message", type: "string" },
          ],
          name: "donate",
          outputs: [],
          stateMutability: "payable",
          type: "function",
        },
        {
          inputs: [
            { internalType: "address", name: "_address", type: "address" },
            { internalType: "string", name: "_name", type: "string" },
            { internalType: "string", name: "_description", type: "string" },
          ],
          name: "registerBeneficiary",
          outputs: [],
          stateMutability: "nonpayable",
          type: "function",
        },
        {
          inputs: [],
          name: "getTotalDonations",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [
            { internalType: "uint256", name: "_index", type: "uint256" },
          ],
          name: "getBeneficiary",
          outputs: [
            { internalType: "address", name: "", type: "address" },
            { internalType: "string", name: "", type: "string" },
            { internalType: "string", name: "", type: "string" },
          ],
          stateMutability: "view",
          type: "function",
        },
        {
          inputs: [],
          name: "getBeneficiaryCount",
          outputs: [{ internalType: "uint256", name: "", type: "uint256" }],
          stateMutability: "view",
          type: "function",
        },
      ];

      // 초기화 함수
      async function init() {
        // 탭 클릭 이벤트 리스너
        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            document
              .querySelectorAll(".tab")
              .forEach((t) => t.classList.remove("active"));
            document
              .querySelectorAll(".tab-content")
              .forEach((tc) => tc.classList.remove("active"));

            tab.classList.add("active");
            document.getElementById(tab.dataset.tab).classList.add("active");
          });
        });

        // 버튼 이벤트 리스너
        document
          .getElementById("connectWallet")
          .addEventListener("click", connectWallet);
        document
          .getElementById("donateButton")
          .addEventListener("click", makeDonation);
        document
          .getElementById("registerButton")
          .addEventListener("click", registerBeneficiary);
        document
          .getElementById("loadContractButton")
          .addEventListener("click", loadContractInfo);

        // 메타마스크가 설치되어 있는지 확인
        if (typeof window.ethereum !== "undefined") {
          console.log("MetaMask가 설치되어 있습니다!");

          // 계정 변경 이벤트 처리
          window.ethereum.on("accountsChanged", (accounts) => {
            updateAccountInfo(accounts[0]);
          });

          // 체인 변경 이벤트 처리
          window.ethereum.on("chainChanged", () => {
            window.location.reload();
          });

          // 자동 연결 시도
          try {
            await connectWallet();
          } catch (error) {
            console.error("자동 연결 실패:", error);
          }
        } else {
          alert("MetaMask를 설치해주세요!");
        }
      }

      // 지갑 연결 함수
      async function connectWallet() {
        try {
          const accounts = await window.ethereum.request({
            method: "eth_requestAccounts",
          });
          web3 = new Web3(window.ethereum);

          updateAccountInfo(accounts[0]);
          showStatus("connectWallet", "지갑이 연결되었습니다!");

          return accounts;
        } catch (error) {
          console.error("지갑 연결 오류:", error);
          showStatus(
            "connectWallet",
            "지갑 연결에 실패했습니다: " + error.message,
            true
          );
        }
      }

      // 계정 정보 업데이트
      async function updateAccountInfo(account) {
        if (!account) return;

        // 주소 표시
        const accountElement = document.getElementById("accountAddress");
        accountElement.textContent = account;

        // 잔액 표시
        const balance = await web3.eth.getBalance(account);
        const balanceInEth = web3.utils.fromWei(balance, "ether");
        document.getElementById("accountBalance").textContent =
          parseFloat(balanceInEth).toFixed(4);
      }

      // 기부 함수
      async function makeDonation() {
        try {
          if (!web3 || !donationContract) {
            alert("지갑을 연결하고 컨트랙트 주소를 입력해주세요.");
            return;
          }

          const accounts = await web3.eth.getAccounts();
          const amount = document.getElementById("donationAmount").value;
          const message =
            document.getElementById("donationMessage").value || "";

          // 기부 금액 검증
          if (!amount || parseFloat(amount) <= 0) {
            alert("기부 금액을 입력해주세요.");
            return;
          }

          const amountInWei = web3.utils.toWei(amount, "ether");

          // 트랜잭션 실행
          showStatus("donationStatus", "기부 트랜잭션 처리 중...", false, true);

          const receipt = await donationContract.methods.donate(message).send({
            from: accounts[0],
            value: amountInWei,
            gas: 300000,
          });

          showStatus(
            "donationStatus",
            `기부에 성공했습니다! 트랜잭션 해시: ${receipt.transactionHash}`
          );

          // 계정 정보 업데이트
          updateAccountInfo(accounts[0]);

          // 기부 후 컨트랙트 정보 새로고침
          if (document.getElementById("contractAddress").value) {
            await loadContractInfo();
          }
        } catch (error) {
          console.error("기부 오류:", error);
          showStatus(
            "donationStatus",
            "기부 중 오류가 발생했습니다: " + error.message,
            true
          );
        }
      }

      // 수혜자 등록 함수
      async function registerBeneficiary() {
        try {
          if (!web3 || !donationContract) {
            alert("지갑을 연결하고 컨트랙트 주소를 입력해주세요.");
            return;
          }

          const accounts = await web3.eth.getAccounts();
          const address = document.getElementById("beneficiaryAddress").value;
          const name = document.getElementById("beneficiaryName").value;
          const description = document.getElementById(
            "beneficiaryDescription"
          ).value;

          // 입력값 검증
          if (!address || !web3.utils.isAddress(address)) {
            alert("올바른 이더리움 주소를 입력해주세요.");
            return;
          }

          if (!name) {
            alert("수혜자 이름을 입력해주세요.");
            return;
          }

          // 트랜잭션 실행
          showStatus(
            "registrationStatus",
            "수혜자 등록 트랜잭션 처리 중...",
            false,
            true
          );

          const receipt = await donationContract.methods
            .registerBeneficiary(address, name, description)
            .send({
              from: accounts[0],
              gas: 300000,
            });

          showStatus(
            "registrationStatus",
            `수혜자 등록에 성공했습니다! 트랜잭션 해시: ${receipt.transactionHash}`
          );

          // 등록 후 컨트랙트 정보 새로고침
          if (document.getElementById("contractAddress").value) {
            await loadContractInfo();
          }
        } catch (error) {
          console.error("수혜자 등록 오류:", error);
          showStatus(
            "registrationStatus",
            "수혜자 등록 중 오류가 발생했습니다: " + error.message,
            true
          );
        }
      }

      // 컨트랙트 정보 로드 함수
      async function loadContractInfo() {
        try {
          const contractAddress =
            document.getElementById("contractAddress").value;

          if (!web3) {
            await connectWallet();
          }

          if (!contractAddress || !web3.utils.isAddress(contractAddress)) {
            alert("올바른 컨트랙트 주소를 입력해주세요.");
            return;
          }

          donationContract = new web3.eth.Contract(
            contractABI,
            contractAddress
          );

          // 컨트랙트 정보 로드 중 표시
          showStatus("contractStatus", "컨트랙트 정보 로드 중...", false, true);

          // 총 기부 금액 가져오기
          const totalDonations = await donationContract.methods
            .getTotalDonations()
            .call();
          document.getElementById("totalDonations").textContent =
            web3.utils.fromWei(totalDonations, "ether") + " ETH";

          // 수혜자 목록 가져오기
          const beneficiaryCount = await donationContract.methods
            .getBeneficiaryCount()
            .call();
          const tbody = document.querySelector("#beneficiariesTable tbody");
          tbody.innerHTML = "";

          if (beneficiaryCount > 0) {
            for (let i = 0; i < beneficiaryCount; i++) {
              const beneficiary = await donationContract.methods
                .getBeneficiary(i)
                .call();
              const row = document.createElement("tr");

              const addressCell = document.createElement("td");
              addressCell.textContent = beneficiary[0];

              const nameCell = document.createElement("td");
              nameCell.textContent = beneficiary[1];

              const descriptionCell = document.createElement("td");
              descriptionCell.textContent = beneficiary[2];

              row.appendChild(addressCell);
              row.appendChild(nameCell);
              row.appendChild(descriptionCell);

              tbody.appendChild(row);
            }
          } else {
            const row = document.createElement("tr");
            const cell = document.createElement("td");
            cell.colSpan = 3;
            cell.textContent = "등록된 수혜자가 없습니다.";
            cell.style.textAlign = "center";
            row.appendChild(cell);
            tbody.appendChild(row);
          }

          showStatus(
            "contractStatus",
            "컨트랙트 정보가 성공적으로 로드되었습니다."
          );
        } catch (error) {
          console.error("컨트랙트 정보 로드 오류:", error);
          showStatus(
            "contractStatus",
            "컨트랙트 정보 로드 중 오류가 발생했습니다: " + error.message,
            true
          );
        }
      }

      // 상태 메시지 표시 함수
      function showStatus(
        elementId,
        message,
        isError = false,
        isLoading = false
      ) {
        const statusElement = document.getElementById(elementId);
        if (!statusElement) return;

        statusElement.textContent = message;
        statusElement.style.display = "block";

        if (isError) {
          statusElement.classList.add("error");
        } else {
          statusElement.classList.remove("error");
        }

        if (isLoading) {
          const loadingSpinner = document.createElement("span");
          loadingSpinner.className = "loading";
          statusElement.appendChild(loadingSpinner);
        }
      }

      // 페이지 로드 시 초기화
      window.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>
